# 脂肪分数分析软件 v2.1

Fat Fraction Analysis Software v2.1

## 目录

- [项目简介](#项目简介)
- [主要功能](#主要功能)
- [快速开始](#快速开始)
- [使用说明](#使用说明)
- [各模式详细说明](#各模式详细说明)
  - [交互式2D模式](#1-交互式2d模式)
  - [交互式3D模式](#2-交互式3d模式)
  - [批量2D模式](#3-批量2d模式)
  - [批量3D模式](#4-批量3d模式)
- [文件格式和命名要求](#文件格式和命名要求)
- [通用快捷键](#通用快捷键)
- [使用技巧和注意事项](#使用技巧和注意事项)
- [项目结构](#项目结构)
- [安装说明](#安装说明)
- [依赖库](#依赖库)
- [技术特点](#技术特点)
- [开发信息](#开发信息)
- [许可证](#许可证)
- [联系方式](#联系方式)

## 项目简介

这是一个专业的医学图像脂肪分数分析软件，支持2D和3D图像的交互式和批量处理模式。软件可以加载医学图像，绘制感兴趣区域(ROI)，并计算脂肪分数值。

## 主要功能

### 交互式模式
- **2D交互模式**：支持单张2D图像的分析
- **3D交互模式**：支持3D医学图像（NIfTI格式）的切片分析

### 批量处理模式
- **2D批量模式**：批量处理多张2D图像
- **3D批量模式**：批量处理多个3D医学图像

### ROI绘制功能
- **矩形ROI**：支持矩形区域绘制
- **圆形ROI**：支持圆形区域绘制
- **多边形ROI**：支持自由多边形区域绘制

### 图像处理功能
- **图像旋转**：支持90°、180°、270°旋转
- **坐标转换**：自动处理旋转后的坐标转换
- **图像缩放**：自适应窗口大小

## 项目结构

```
脂肪分数分析软件/
├── main.py                 # 主程序入口
├── requirements.txt        # 依赖库列表
├── README.md              # 项目说明文档
├── .gitignore             # Git忽略文件
└── src/                   # 源代码目录
    ├── main.py            # 程序主逻辑
    ├── gui_main.py        # 主界面控制器
    ├── gui_base.py        # GUI基类
    ├── gui_interactive_2d.py  # 2D交互模式界面
    ├── gui_interactive_3d.py  # 3D交互模式界面
    ├── gui_batch_2d.py    # 2D批量模式界面
    ├── gui_batch_3d.py    # 3D批量模式界面
    ├── analyzer.py        # 脂肪分数分析器
    ├── nifti_viewer.py    # 3D图像查看器
    └── utils.py           # 工具函数
```

## 安装说明

### 环境要求
- Python 3.7+
- Windows 10+ / macOS 10.14+ / Linux

### 安装步骤

1. **克隆或下载项目**
   ```bash
   git clone <项目地址>
   cd 脂肪分数分析软件
   ```

2. **创建虚拟环境（推荐）**
   ```bash
   conda create -n ff_analyzer python=3.12
   conda activate ff_analyzer
   ```

3. **安装依赖库**
   ```bash
   pip install -r requirements.txt
   ```

4. **运行程序**
   ```bash
   python main.py
   ```

## 依赖库

- **opencv-python==4.12.0.88** - 图像处理
- **numpy==1.26.4** - 数组操作
- **Pillow==11.3.0** - 图像格式转换
- **nibabel==5.3.2** - 3D医学图像处理
- **matplotlib==3.10.3** - 数据可视化
- **pandas==2.3.1** - 数据处理
- **scipy==1.15.3** - 科学计算

## 快速开始

### 1. 安装和启动
```bash
# 安装依赖
pip install -r requirements.txt

# 启动软件
python main.py
```

### 2. 选择模式
启动后选择相应的分析模式：
- **交互式2D**：单张图像分析（推荐新手）
- **交互式3D**：3D医学图像分析
- **批量2D**：批量处理2D图像
- **批量3D**：批量处理3D图像

### 3. 基本操作流程
1. **加载图像**：点击"打开图像"或"选择图像文件夹"
2. **绘制ROI**：选择ROI类型，在图像上绘制感兴趣区域
3. **保存ROI**：按S键保存当前ROI
4. **查看结果**：ROI上会显示脂肪分数值
5. **导出结果**：点击"导出结果"保存分析数据

## 使用说明

### 启动软件
运行 `python main.py` 启动软件，选择相应的模式：
- **交互式2D**：单张图像分析
- **交互式3D**：3D医学图像分析
- **批量2D**：批量处理2D图像
- **批量3D**：批量处理3D图像

## 各模式详细说明

### 1. 交互式2D模式

#### 使用逻辑
1. **打开图像**：选择单张2D图像文件
2. **绘制ROI**：选择ROI类型，在图像上绘制感兴趣区域
3. **保存ROI**：按S键保存当前ROI，自动计算脂肪分数
4. **继续绘制**：可继续绘制多个ROI
5. **保存结果**：导出图像和JSON数据

#### 快捷键
- **S键**：保存当前ROI
- **Ctrl+R**：旋转图像90°
- **Ctrl+Shift+R**：旋转图像270°
- **Ctrl+S**：保存当前图像和ROI
- **Ctrl+O**：打开图像
- **Ctrl+A**：清除所有ROI
- **Escape**：取消当前操作
- **Enter**：完成多边形绘制
- **A/D键** 或 **左右箭头**：上一张/下一张图像
- **鼠标左键拖拽**：绘制矩形ROI
- **鼠标左键点击**：绘制圆形ROI
- **鼠标左键点击**：绘制多边形ROI（点击首尾两点闭合）

#### 支持格式
- **图像格式**：BMP, JPG, JPEG, PNG, TIFF, TIF
- **输出格式**：PNG图像 + JSON数据

### 2. 交互式3D模式

#### 使用逻辑
1. **打开3D图像**：选择NIfTI格式的3D医学图像
2. **选择视图**：轴向(Axial)、矢状(Sagittal)、冠状(Coronal)
3. **切换切片**：使用鼠标滚轮或X键切换切片
4. **绘制ROI**：在当前切片上绘制ROI
5. **保存ROI**：按S键保存当前切片的ROI
6. **批量保存**：保存所有有ROI的切片

#### 快捷键
- **S键**：保存当前切片的ROI
- **A/D键** 或 **左右箭头**：上一张/下一张切片
- **W/X键** 或 **上下箭头**：上一张/下一张切片
- **V键**：切换视图（轴向/矢状/冠状）
- **Ctrl+R**：旋转图像90°
- **Ctrl+Shift+R**：旋转图像270°
- **Ctrl+S**：保存当前图像和ROI
- **Ctrl+O**：打开图像
- **Ctrl+A**：清除所有ROI
- **Escape**：取消当前操作
- **Enter**：完成多边形绘制
- **鼠标滚轮**：切换切片
- **鼠标左键拖拽**：绘制矩形ROI
- **鼠标左键点击**：绘制圆形ROI
- **鼠标左键点击**：绘制多边形ROI（点击首尾两点闭合）

#### 支持格式
- **图像格式**：NIfTI (.nii, .nii.gz)
- **输出格式**：PNG图像 + JSON数据

### 3. 批量2D模式

#### 使用逻辑
1. **选择图像文件夹**：选择包含2D图像的文件夹
2. **选择标签文件夹**：选择包含对应标签图像的文件夹
3. **查看图像**：浏览图像和对应的标签
4. **开始处理**：自动匹配图像和标签，计算脂肪分数
5. **导出结果**：生成Excel汇总表和可选的JSON文件

#### 快捷键
- **A/D键** 或 **左右箭头**：上一张/下一张图像
- **空格键**：开始/停止批量处理
- **Ctrl+E**：导出结果
- **Ctrl+O**：打开图像文件夹
- **Ctrl+S**：保存当前图像和ROI
- **Ctrl+R**：旋转图像90°
- **Ctrl+Shift+R**：旋转图像270°
- **Ctrl+A**：清除所有ROI
- **Escape**：取消当前操作

#### 支持格式
- **图像格式**：BMP, JPG, JPEG, PNG, TIFF, TIF
- **标签格式**：BMP, JPG, JPEG, PNG, TIFF, TIF
- **输出格式**：Excel表格 + 可选JSON文件

#### 命名要求
- **图像文件**：`image_name.png`
- **标签文件**：`image_name_roi.png` 或 `image_name.png`
- **支持数字后缀**：`image_name_0000.png` → `image_name_roi.png`

### 4. 批量3D模式

#### 使用逻辑
1. **选择图像文件夹**：选择包含3D图像的文件夹
2. **选择标签文件夹**：选择包含对应标签图像的文件夹
3. **查看图像**：浏览3D图像和对应的标签
4. **开始处理**：自动匹配图像和标签，计算脂肪分数
5. **导出结果**：生成Excel汇总表和可选的JSON文件

#### 快捷键
- **A/D键** 或 **左右箭头**：上一张/下一张3D图像
- **W/S键** 或 **上下箭头**：上一张/下一张切片
- **V键**：切换视图（轴向/矢状/冠状）
- **空格键**：开始/停止批量处理
- **Ctrl+E**：导出结果
- **Ctrl+O**：打开图像文件夹
- **Ctrl+S**：保存当前图像和ROI
- **Ctrl+R**：旋转图像90°
- **Ctrl+Shift+R**：旋转图像270°
- **Ctrl+A**：清除所有ROI
- **Escape**：取消当前操作

#### 支持格式
- **图像格式**：NIfTI (.nii, .nii.gz)
- **标签格式**：BMP, JPG, JPEG, PNG, TIFF, TIF
- **输出格式**：Excel表格 + 可选JSON文件

#### 命名要求
- **图像文件**：`image_name.nii.gz`
- **标签文件**：`image_name_roi.png` 或 `image_name.png`
- **支持数字后缀**：`image_name_0000.nii.gz` → `image_name_roi.png`

## 文件格式和命名要求

### 支持的图像格式

#### 2D图像格式
- **BMP**：Windows位图格式
- **JPG/JPEG**：JPEG压缩格式
- **PNG**：便携式网络图形格式
- **TIFF/TIF**：标记图像文件格式

#### 3D图像格式
- **NIfTI**：神经影像信息技术倡议格式
  - `.nii`：标准NIfTI格式
  - `.nii.gz`：压缩NIfTI格式

### 标签文件命名规则

#### 完全匹配
- 图像：`image_name.png`
- 标签：`image_name_roi.png`

#### 数字后缀匹配
- 图像：`image_name_0000.png`
- 标签：`image_name_roi.png`

#### 直接匹配
- 图像：`image_name_0000.png`
- 标签：`image_name.png`

### 输出文件说明

#### 交互式模式输出
- **图像文件**：`image_name_roi.png`（带ROI标注的图像）
- **JSON文件**：`image_name_roi_data.json`（ROI数据和脂肪分数）

#### 批量模式输出
- **Excel文件**：`batch_analysis_results.xlsx`（汇总分析结果）
- **CSV文件**：`batch_analysis_results.csv`（Excel保存失败时的备选）
- **JSON文件**：`image_name_roi_data.json`（可选，每个图像单独保存）

## 通用快捷键

### 全局快捷键
- **S键**：保存当前ROI
- **Ctrl+R**：旋转图像90°
- **Ctrl+Shift+R**：旋转图像270°
- **Ctrl+S**：保存当前图像和ROI
- **Ctrl+O**：打开图像
- **Ctrl+A**：清除所有ROI
- **Ctrl+Q**：退出程序
- **Escape**：取消当前操作
- **Enter**：完成多边形绘制
- **Q键**：自动计算并显示

### 交互式模式专用
- **A/D键** 或 **左右箭头**：上一张/下一张图像
- **鼠标左键拖拽**：绘制矩形ROI
- **鼠标左键点击**：绘制圆形ROI
- **鼠标左键点击**：绘制多边形ROI（点击首尾两点闭合）

### 3D模式专用
- **W/X键** 或 **上下箭头**：上一张/下一张切片
- **V键**：切换视图（轴向/矢状/冠状）
- **鼠标滚轮**：切换切片

### 批量模式专用
- **空格键**：开始/停止批量处理
- **Ctrl+E**：导出结果

## 使用技巧和注意事项

### 图像处理技巧
1. **ROI绘制**：
   - 矩形ROI：按住鼠标左键拖拽绘制
   - 圆形ROI：点击鼠标左键确定圆心，拖拽确定半径
   - 多边形ROI：连续点击鼠标左键绘制顶点，点击首尾两点闭合或按Enter完成

2. **图像旋转**：
   - 使用Ctrl+R可以90°旋转图像
   - 旋转后ROI坐标会自动调整
   - 支持多次旋转（90°、180°、270°）

3. **3D图像操作**：
   - 使用鼠标滚轮快速切换切片
   - 不同视图（轴向、矢状、冠状）显示不同方向的切片
   - 每个切片的ROI独立保存

### 批量处理技巧
1. **文件匹配**：
   - 软件会自动尝试多种匹配方式
   - 支持带数字后缀的文件名
   - 建议保持图像和标签文件名的对应关系

2. **结果导出**：
   - Excel文件包含所有ROI的详细信息
   - 相同图像的ROI会合并显示，使表格更美观
   - 可选择是否保存单独的JSON文件

3. **性能优化**：
   - 3D图像会进行缓存，提高切换速度
   - 批量处理支持进度显示
   - 可以随时停止处理过程

### 常见问题解决
1. **图像无法加载**：检查文件格式是否支持
2. **标签匹配失败**：检查文件命名是否符合要求
3. **ROI位置错位**：尝试重新绘制或检查图像是否旋转
4. **导出失败**：检查输出目录权限和磁盘空间

## 技术特点

- **模块化设计**：清晰的代码结构，易于维护和扩展
- **面向对象**：使用继承和多态，代码复用性高
- **错误处理**：完善的异常处理和日志记录
- **内存管理**：3D图像缓存机制，优化内存使用
- **坐标系统**：精确的坐标转换，支持图像旋转

## 开发信息

- **版本**：v2.1
- **开发语言**：Python 3.12
- **GUI框架**：Tkinter
- **图像处理**：OpenCV
- **版本控制**：Git

## 许可证

本项目仅供学习和研究使用。

## 联系方式

如有问题或建议，请联系开发团队。
